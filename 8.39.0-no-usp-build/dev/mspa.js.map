{"version":3,"file":"mspa.js","mappings":"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","sources":["webpack://prebid.js/./libraries/mspa/activityControls.js"],"sourcesContent":["import {registerActivityControl} from '../../src/activities/rules.js';\nimport {\n  ACTIVITY_ENRICH_EIDS,\n  ACTIVITY_ENRICH_UFPD,\n  ACTIVITY_SYNC_USER,\n  ACTIVITY_TRANSMIT_PRECISE_GEO\n} from '../../src/activities/activities.js';\nimport {gppDataHandler} from '../../src/adapterManager.js';\nimport {logInfo} from '../../src/utils.js';\n\n// default interpretation for MSPA consent(s):\n// https://docs.prebid.org/features/mspa-usnat.html\n\nconst SENSITIVE_DATA_GEO = 7;\n\nfunction isApplicable(val) {\n  return val != null && val !== 0\n}\n\nexport function isBasicConsentDenied(cd) {\n  // service provider mode is always consent denied\n  return ['MspaServiceProviderMode', 'Gpc'].some(prop => cd[prop] === 1) ||\n    // you cannot consent to what you were not notified of\n    cd.PersonalDataConsents === 2 ||\n    // minors 13+ who have not given consent\n    cd.KnownChildSensitiveDataConsents[0] === 1 ||\n    // minors under 13 cannot consent\n    isApplicable(cd.KnownChildSensitiveDataConsents[1]) ||\n    // covered cannot be zero\n    cd.MspaCoveredTransaction === 0;\n}\n\nexport function sensitiveNoticeIs(cd, value) {\n  return ['SensitiveDataProcessingOptOutNotice', 'SensitiveDataLimitUseNotice'].some(prop => cd[prop] === value)\n}\n\nexport function isConsentDenied(cd) {\n  return isBasicConsentDenied(cd) ||\n    ['Sale', 'Sharing', 'TargetedAdvertising'].some(scope => {\n      const oo = cd[`${scope}OptOut`];\n      const notice = cd[`${scope}OptOutNotice`];\n      // user opted out\n      return oo === 1 ||\n      // opt-out notice was not given\n        notice === 2 ||\n      // do not trust CMP if it signals opt-in but no opt-out notice was given\n        (oo === 2 && notice === 0);\n    }) ||\n    // no sharing notice was given ...\n    cd.SharingNotice === 2 ||\n    // ... or the CMP says it was not applicable, while also claiming it got consent\n    (cd.SharingOptOut === 2 && cd.SharingNotice === 0);\n}\n\nexport const isTransmitUfpdConsentDenied = (() => {\n  // deny anything that smells like: genetic, biometric, state/national ID, financial, union membership,\n  // or personal communication data\n  const cannotBeInScope = [6, 7, 9, 10, 12].map(el => --el);\n  // require consent for everything else (except geo, which is treated separately)\n  const allExceptGeo = Array.from(Array(12).keys()).filter((el) => el !== SENSITIVE_DATA_GEO)\n  const mustHaveConsent = allExceptGeo.filter(el => !cannotBeInScope.includes(el));\n\n  return function (cd) {\n    return isConsentDenied(cd) ||\n      // no notice about sensitive data was given\n      sensitiveNoticeIs(cd, 2) ||\n      // extra-sensitive data is applicable\n      cannotBeInScope.some(i => isApplicable(cd.SensitiveDataProcessing[i])) ||\n      // user opted out for not-as-sensitive data\n      mustHaveConsent.some(i => cd.SensitiveDataProcessing[i] === 1) ||\n      // CMP says it has consent, but did not give notice about it\n      (sensitiveNoticeIs(cd, 0) && allExceptGeo.some(i => cd.SensitiveDataProcessing[i] === 2))\n  }\n})();\n\nexport function isTransmitGeoConsentDenied(cd) {\n  const geoConsent = cd.SensitiveDataProcessing[SENSITIVE_DATA_GEO];\n  return geoConsent === 1 ||\n    isBasicConsentDenied(cd) ||\n    // no sensitive data notice was given\n    sensitiveNoticeIs(cd, 2) ||\n    // do not trust CMP if it says it has consent for geo but didn't show a sensitive data notice\n    (sensitiveNoticeIs(cd, 0) && geoConsent === 2)\n}\n\nconst CONSENT_RULES = {\n  [ACTIVITY_SYNC_USER]: isConsentDenied,\n  [ACTIVITY_ENRICH_EIDS]: isConsentDenied,\n  [ACTIVITY_ENRICH_UFPD]: isTransmitUfpdConsentDenied,\n  [ACTIVITY_TRANSMIT_PRECISE_GEO]: isTransmitGeoConsentDenied\n};\n\nexport function mspaRule(sids, getConsent, denies, applicableSids = () => gppDataHandler.getConsentData()?.applicableSections) {\n  return function () {\n    if (applicableSids().some(sid => sids.includes(sid))) {\n      const consent = getConsent();\n      if (consent == null) {\n        return {allow: false, reason: 'consent data not available'};\n      }\n      if (denies(consent)) {\n        return {allow: false};\n      }\n    }\n  };\n}\n\nfunction flatSection(subsections) {\n  if (subsections == null) return subsections;\n  return subsections.reduceRight((subsection, consent) => {\n    return Object.assign(consent, subsection);\n  }, {});\n}\n\nexport function setupRules(api, sids, normalizeConsent = (c) => c, rules = CONSENT_RULES, registerRule = registerActivityControl, getConsentData = () => gppDataHandler.getConsentData()) {\n  const unreg = [];\n  const ruleName = `MSPA (GPP '${api}' for section${sids.length > 1 ? 's' : ''} ${sids.join(', ')})`;\n  logInfo(`Enabling activity controls for ${ruleName}`)\n  Object.entries(rules).forEach(([activity, denies]) => {\n    unreg.push(registerRule(activity, ruleName, mspaRule(\n      sids,\n      () => normalizeConsent(flatSection(getConsentData()?.parsedSections?.[api])),\n      denies,\n      () => getConsentData()?.applicableSections || []\n    )));\n  });\n  return () => unreg.forEach(ur => ur());\n}\n"],"names":["registerActivityControl","ACTIVITY_ENRICH_EIDS","ACTIVITY_ENRICH_UFPD","ACTIVITY_SYNC_USER","ACTIVITY_TRANSMIT_PRECISE_GEO","gppDataHandler","logInfo","SENSITIVE_DATA_GEO","isApplicable","val","isBasicConsentDenied","cd","some","prop","PersonalDataConsents","KnownChildSensitiveDataConsents","MspaCoveredTransaction","sensitiveNoticeIs","value","isConsentDenied","scope","oo","concat","notice","SharingNotice","SharingOptOut","isTransmitUfpdConsentDenied","cannotBeInScope","map","el","allExceptGeo","Array","from","keys","filter","mustHaveConsent","includes","i","SensitiveDataProcessing","isTransmitGeoConsentDenied","geoConsent","CONSENT_RULES","_CONSENT_RULES","_defineProperty","mspaRule","sids","getConsent","denies","applicableSids","arguments","length","undefined","_gppDataHandler$getCo","getConsentData","applicableSections","sid","consent","allow","reason","flatSection","subsections","reduceRight","subsection","Object","assign","setupRules","api","normalizeConsent","c","rules","registerRule","unreg","ruleName","join","entries","forEach","_ref","_ref2","_slicedToArray","activity","push","_getConsentData","_getConsentData$parse","parsedSections","_getConsentData2","ur"],"sourceRoot":""}