{"version":3,"file":"gdprEnforcement.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAA6D;AAA7D;AACA;AACA;;AAE8D;AACtB;AACiC;AAC9B;AACG;AAC4C;AAOpD;AAKD;AAC8B;AAO1B;AAElC,IAAM+B,0BAA0B,GAAG,0BAA0B;AAE7D,IAAMC,YAAY,GAAG;EAC1BC,OAAO,EAAE,CAAC,CAAC;EACXC,OAAO,EAAE,CAAC;AACZ,CAAC;AAED,IAAMC,aAAa,GAAG;EACpBF,OAAO,EAAE,kBAAkB;EAC3BC,OAAO,EAAE;AACX,CAAC;AAED,IAAME,kBAAkB,GAAG;EACzBC,OAAO,EAAE;IACPC,IAAI,EAAE,SAAS;IACfC,OAAO,EAAE;MACPN,OAAO,EAAE,SAAS;MAClBO,cAAc,EAAE,IAAI;MACpBC,aAAa,EAAE,IAAI;MACnBC,gBAAgB,EAAE;IACpB,CAAC;IACDC,EAAE,EAAE;EACN,CAAC;EACDC,QAAQ,EAAE;IACRN,IAAI,EAAE,SAAS;IACfK,EAAE,EAAE,CAAC;IACLJ,OAAO,EAAE;MACPN,OAAO,EAAE,UAAU;MACnBO,cAAc,EAAE,IAAI;MACpBC,aAAa,EAAE,IAAI;MACnBC,gBAAgB,EAAE;IACpB;EACF,CAAC;EACDG,eAAe,EAAE;IACfP,IAAI,EAAE,SAAS;IACfK,EAAE,EAAE;EACN,CAAC;EACDG,WAAW,EAAE;IACXR,IAAI,EAAE,SAAS;IACfK,EAAE,EAAE;EACN,CAAC;EACDI,kBAAkB,EAAE;IAClBT,IAAI,EAAE,SAAS;IACfK,EAAE,EAAE;EACN;AACF,CAAC;AAED,IAAMK,cAAc,GAAG,IAAIC,GAAG,CAAC,CAAC;AAChC,IAAMC,cAAc,GAAG,IAAID,GAAG,CAAC,CAAC;AAChC,IAAME,gBAAgB,GAAG,IAAIF,GAAG,CAAC,CAAC;AAClC,IAAMG,WAAW,GAAG,IAAIH,GAAG,CAAC,CAAC;AAC7B,IAAMI,WAAW,GAAG,IAAIJ,GAAG,CAAC,CAAC;AAC7B,IAAMK,UAAU,GAAG,IAAIL,GAAG,CAAC,CAAC;AAE5B,IAAIM,UAAU,GAAG,KAAK;AACtB,IAAIC,wBAAwB,GAAG,KAAK;AAEpC,IAAMC,qBAAqB,GAAG,CAC5B3C,0EAAkB,EAClBG,uEAAe,EACfJ,6EAAqB,EACrBG,uEAAe,CAChB;AAED,IAAM0C,SAAS,GAAG,MAAM;AACxB,IAAMC,YAAY,GAAG,EAAE;;AAEvB;AACA,IAAMC,WAAW,GAAG,CAAC,CAAC,CAAC;;AAEvB;AACA;AACA;AACO,SAASC,QAAQA,CAACC,UAAU,EAAEC,UAAU,EAAEC,UAAU,EAAE;EAC3D,IAAID,UAAU,EAAE;IACd;IACA,IAAME,UAAU,GAAG5D,4DAAgB,CAAC,YAAY,CAAC;;IAEjD;IACA,IAAI4D,UAAU,IAAIA,UAAU,CAACF,UAAU,CAAC,EAAE;MACxC,OAAOE,UAAU,CAACF,UAAU,CAAC;IAC/B,CAAC,MAAM,IAAID,UAAU,KAAK/C,0EAAkB,EAAE;MAC5C,OAAOgD,UAAU,KAAK,MAAM,GAAGnD,qEAAiB,GAAGD,oEAAgB;IACrE,CAAC,MAAM;MACL,IAAAwD,gBAAA,GAAuBzD,mEAAe,CAACqD,UAAU,CAAC;QAA7CM,KAAK,GAAAF,gBAAA,CAALE,KAAK;QAAEC,OAAO,GAAAH,gBAAA,CAAPG,OAAO;MACnB,IAAID,KAAK,IAAI,IAAI,IAAIE,MAAM,CAACC,IAAI,CAACF,OAAO,CAAC,CAACG,MAAM,GAAG,CAAC,EAAE;QACpD;QACA;QAAA,IAAAC,SAAA,GAAAC,0BAAA,CACmBlB,qBAAqB;UAAAmB,KAAA;QAAA;UAAxC,KAAAF,SAAA,CAAAG,CAAA,MAAAD,KAAA,GAAAF,SAAA,CAAAI,CAAA,IAAAC,IAAA,GAA0C;YAAA,IAA/BzC,IAAI,GAAAsC,KAAA,CAAAI,KAAA;YACb,IAAIV,OAAO,CAACW,cAAc,CAAC3C,IAAI,CAAC,EAAE;cAChC+B,KAAK,GAAGC,OAAO,CAAChC,IAAI,CAAC;cACrB,IAAIA,IAAI,KAAKwB,UAAU,EAAE;gBACvB1D,sDAAO,uCAAA8E,MAAA,CAAuCnB,UAAU,mBAAAmB,MAAA,CAAgB5C,IAAI,oBAAA4C,MAAA,CAAiBb,KAAK,uBAAAa,MAAA,CAAoBpB,UAAU,aAAAoB,MAAA,CAAUZ,OAAO,CAACR,UAAU,CAAC,MAAG,CAAC;cACnK;cACA;YACF;UACF;QAAC,SAAAqB,GAAA;UAAAT,SAAA,CAAAU,CAAA,CAAAD,GAAA;QAAA;UAAAT,SAAA,CAAAW,CAAA;QAAA;MACH;MACA,IAAIhB,KAAK,IAAI,IAAI,IAAIL,UAAU,EAAE;QAC/BK,KAAK,GAAGL,UAAU,CAAC,CAAC;MACtB;MACA,OAAOK,KAAK,IAAI,IAAI;IACtB;EACF;EACA,OAAO,IAAI;AACb;;AAEA;AACA;AACA;AACO,SAASiB,4BAA4BA,CAACC,IAAI,EAAElF,MAAM,EAAE;EAAA,IAAAmF,gBAAA;EACzD,IAAMC,OAAO,GAAGnF,kFAAkC,CAACiF,IAAI,CAAC;EACxD,OAAQ,UAAClB,KAAK,EAAK;IACjB,IAAI,OAAOA,KAAK,KAAK,UAAU,EAAE,OAAOA,KAAK;IAC7C,IAAI;MACF,OAAOA,KAAK,CAACsB,IAAI,CAACF,OAAO,CAACA,OAAO,EAAEpF,MAAM,CAAC;IAC5C,CAAC,CAAC,OAAO+E,CAAC,EAAE;MACVjF,uDAAQ,mBAAA+E,MAAA,CAAmBK,IAAI,uBAAoBH,CAAC,CAAC;IACvD;EACF,CAAC,CAAEK,OAAO,aAAPA,OAAO,wBAAAD,gBAAA,GAAPC,OAAO,CAAEA,OAAO,cAAAD,gBAAA,uBAAhBA,gBAAA,CAAkBnB,KAAK,CAAC;AAC7B;AAEO,SAASuB,aAAaA,CAACC,WAAW,EAAE5D,OAAO,EAAE6D,IAAI,EAAE;EACxD,IAAID,WAAW,IAAI,IAAI,IAAItF,2EAAuB,EAAE;IAClD;IACA;IACA;IACA;IACAH,sDAAO,+CAAA8E,MAAA,CAA+CjD,OAAO,kDAAAiD,MAAA,CAA+CY,IAAI,gBAAAZ,MAAA,CAAgBY,IAAI,SAAM,EAAE,qCAAkC,CAAC;IAC/K,OAAO,IAAI;EACb;EACA,OAAOD,WAAW,IAAIA,WAAW,CAACG,WAAW;AAC/C;AAEA,SAASC,UAAUA,CAACJ,WAAW,EAAEvD,IAAI,EAAEK,EAAE,EAAEuD,KAAK,EAAE;EAChD,IAAIjE,OAAO,GAAG,CAAC,CAAC/B,yDAAU,CAAC2F,WAAW,gBAAAX,MAAA,CAAgB/C,aAAa,CAACG,IAAI,CAAC,OAAA4C,MAAA,CAAIvC,EAAE,CAAE,CAAC;EAClF,IAAIwD,MAAM,GAAG,CAAC,CAACjG,yDAAU,CAAC2F,WAAW,gCAAAX,MAAA,CAAgCgB,KAAK,CAAE,CAAC;EAE7E,IAAI5D,IAAI,KAAK,SAAS,IAAIsB,WAAW,CAACwC,QAAQ,CAACzD,EAAE,CAAC,EAAE;IAClDV,OAAO,KAAPA,OAAO,GAAK,CAAC,CAAC/B,yDAAU,CAAC2F,WAAW,4CAAAX,MAAA,CAA4CvC,EAAE,CAAE,CAAC;IACrFwD,MAAM,KAANA,MAAM,GAAK,CAAC,CAACjG,yDAAU,CAAC2F,WAAW,2CAAAX,MAAA,CAA2CgB,KAAK,CAAE,CAAC;EACxF;EACA,OAAO;IAACjE,OAAO,EAAPA,OAAO;IAAEkE,MAAM,EAANA;EAAM,CAAC;AAC1B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASE,aAAaA,CAACC,IAAI,EAAET,WAAW,EAAEU,aAAa,EAAEL,KAAK,EAAE;EACrE,IAAMM,WAAW,GAAGpE,kBAAkB,CAACkE,IAAI,CAACrE,OAAO,CAAC;;EAEpD;EACA,IAAI,CAACqE,IAAI,CAAC5D,gBAAgB,IAAI,EAAE,EAAE0D,QAAQ,CAACG,aAAa,CAAC,EAAE;IACzD,OAAO,IAAI;EACb;EACA,IAAME,oBAAoB,GAAGH,IAAI,CAAC7D,aAAa,IAAI,EAAGyD,KAAK,KAAKvF,oEAAgB,IAAI,CAAC2F,IAAI,CAACI,oBAAoB,IAAI,EAAE,EAAEN,QAAQ,CAACG,aAAa,CAAC,CAAE;EAC/I,IAAAI,WAAA,GAA0BV,UAAU,CAACJ,WAAW,EAAEW,WAAW,CAAClE,IAAI,EAAEkE,WAAW,CAAC7D,EAAE,EAAEuD,KAAK,CAAC;IAAnFjE,OAAO,GAAA0E,WAAA,CAAP1E,OAAO;IAAEkE,MAAM,GAAAQ,WAAA,CAANR,MAAM;EAEtB,IAAIS,UAAU,GAAG,CAAC,CAACN,IAAI,CAAC9D,cAAc,IAAIP,OAAO,MAAM,CAACwE,oBAAoB,IAAIN,MAAM,CAAC;EAEvF,IAAID,KAAK,KAAKtF,qEAAiB,EAAE;IAC/BgG,UAAU,GAAI,CAACN,IAAI,CAAC9D,cAAc,IAAI,CAAC,CAACtC,yDAAU,CAAC2F,WAAW,mCAAAX,MAAA,CAAmCsB,WAAW,CAAC7D,EAAE,CAAE,CAAE;EACrH;EAEA,OAAOiE,UAAU;AACnB;AAEA,SAASC,QAAQA,CAACC,SAAS,EAAEC,YAAY,EAA8C;EAAA,IAA5CC,OAAO,GAAAC,SAAA,CAAAxC,MAAA,QAAAwC,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG,IAAI;EAAA,IAAEE,aAAa,GAAAF,SAAA,CAAAxC,MAAA,QAAAwC,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG;IAAA,OAAM,IAAI;EAAA;EACnF,OAAO,UAAUG,MAAM,EAAE;IACvB,IAAMvB,WAAW,GAAGtF,kFAA8B,CAAC,CAAC;IACpD,IAAM+G,OAAO,GAAGF,MAAM,CAACjG,oFAA6B,CAAC;IAErD,IAAIyE,aAAa,CAACC,WAAW,EAAEiB,SAAS,EAAEQ,OAAO,CAAC,EAAE;MAClD,IAAMjD,KAAK,GAAGR,QAAQ,CAACuD,MAAM,CAAChG,oFAA6B,CAAC,EAAEkG,OAAO,EAAEH,aAAa,CAACC,MAAM,CAAC,CAAC;MAC7F,IAAIG,KAAK,GAAG,CAAC,CAACR,YAAY,CAAClB,WAAW,EAAEyB,OAAO,EAAEjD,KAAK,CAAC;MACvD,IAAI,CAACkD,KAAK,EAAE;QACVP,OAAO,IAAIA,OAAO,CAACQ,GAAG,CAACF,OAAO,CAAC;QAC/B,OAAO;UAACC,KAAK,EAALA;QAAK,CAAC;MAChB;IACF;EACF,CAAC;AACH;AAEA,SAASE,qBAAqBA,CAACX,SAAS,EAA8C;EAAA,IAA5CE,OAAO,GAAAC,SAAA,CAAAxC,MAAA,QAAAwC,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG,IAAI;EAAA,IAAEE,aAAa,GAAAF,SAAA,CAAAxC,MAAA,QAAAwC,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG;IAAA,OAAM,IAAI;EAAA;EAClF,OAAOJ,QAAQ,CAACC,SAAS,EAAE,UAACY,EAAE,EAAEJ,OAAO,EAAEjD,KAAK;IAAA,OAAK,CAAC,CAACgC,aAAa,CAACrE,YAAY,CAACC,OAAO,CAAC6E,SAAS,CAAC,EAAEY,EAAE,EAAEJ,OAAO,EAAEjD,KAAK,CAAC;EAAA,GAAE2C,OAAO,EAAEG,aAAa,CAAC;AAClJ;AAEA,SAASQ,mBAAmBA,CAACC,MAAM,EAAE;EACnC,OAAO,UAAUR,MAAM,EAAE;IACvB,IAAIA,MAAM,CAAChG,oFAA6B,CAAC,KAAKL,0EAAkB,EAAE;MAChE;MACA;MACA;MACA;IACF;IACA,OAAO6G,MAAM,CAACR,MAAM,CAAC;EACvB,CAAC;AACH;AAEO,IAAMS,gBAAgB,GAAI,UAACvB,IAAI,EAAK;EACzC,OAAO,UAAUc,MAAM,EAAE;IACvB;IACA,IAAIA,MAAM,CAAChG,oFAA6B,CAAC,KAAKL,0EAAkB,IAAI,CAACyC,wBAAwB,EAAE;IAC/F,OAAO8C,IAAI,CAACc,MAAM,CAAC;EACrB,CAAC;AACH,CAAC,CAAEK,qBAAqB,CAAC,CAAC,EAAEzE,cAAc,CAAC,CAAC;AAErC,IAAM8E,YAAY,GAAGL,qBAAqB,CAAC,CAAC,EAAEzE,cAAc,CAAC;AAC7D,IAAM+E,cAAc,GAAGN,qBAAqB,CAAC,CAAC,EAAEzE,cAAc,CAAC;AAC/D,IAAMgF,aAAa,GAAGL,mBAAmB,CAACF,qBAAqB,CAAC,CAAC,EAAEvE,cAAc,CAAC,CAAC;AACnF,IAAM+E,mBAAmB,GAAGR,qBAAqB,CAAC,CAAC,EAAEtE,gBAAgB,EAAE,UAACiE,MAAM;EAAA,OAAK9B,4BAA4B,CAAC8B,MAAM,CAACjG,oFAA6B,CAAC,EAAEiG,MAAM,CAAClG,gFAAyB,CAAC,CAAC;AAAA,EAAC;AAC1L,IAAMgH,QAAQ,GAAGT,qBAAqB,CAAC,CAAC,EAAErE,WAAW,CAAC;AAEtD,IAAM+E,gBAAgB,GAAGR,mBAAmB,CAAE,YAAM;EACzD;EACA;EACA;EACA,SAASS,iBAAiBA,CAACvC,WAAW,EAAEyB,OAAO,EAAEpB,KAAK,EAAE;IACtD,KAAK,IAAImC,GAAG,GAAG,CAAC,EAAEA,GAAG,IAAI,EAAE,EAAEA,GAAG,EAAE,EAAE;MAAA,IAAAC,qBAAA,EAAAC,sBAAA,EAAAC,sBAAA,EAAAC,sBAAA;MAClC,KAAAH,qBAAA,GAAItG,YAAY,CAACC,OAAO,CAACoG,GAAG,CAAC,cAAAC,qBAAA,gBAAAC,sBAAA,GAAzBD,qBAAA,CAA2B5F,gBAAgB,cAAA6F,sBAAA,eAA3CA,sBAAA,CAA6CnC,QAAQ,CAACkB,OAAO,CAAC,EAAE;QAClE,OAAO,IAAI;MACb;MACA,IAAAoB,YAAA,GAA0BzC,UAAU,CAACJ,WAAW,EAAE,SAAS,EAAEwC,GAAG,EAAEnC,KAAK,CAAC;QAAjEjE,OAAO,GAAAyG,YAAA,CAAPzG,OAAO;QAAEkE,MAAM,GAAAuC,YAAA,CAANvC,MAAM;MACtB,IAAIlE,OAAO,KAAKkE,MAAM,KAAAqC,sBAAA,GAAIxG,YAAY,CAACC,OAAO,CAACoG,GAAG,CAAC,cAAAG,sBAAA,gBAAAC,sBAAA,GAAzBD,sBAAA,CAA2B9B,oBAAoB,cAAA+B,sBAAA,eAA/CA,sBAAA,CAAiDrC,QAAQ,CAACkB,OAAO,CAAC,CAAC,EAAE;QAC7F,OAAO,IAAI;MACb;IACF;IACA,OAAO,KAAK;EACd;EAEA,IAAMqB,eAAe,GAAG9B,QAAQ,CAAC,MAAM,EAAEuB,iBAAiB,EAAE/E,WAAW,CAAC;EACxE,IAAMuF,UAAU,GAAGnB,qBAAqB,CAAC,CAAC,EAAEpE,WAAW,CAAC;EACxD,OAAO,YAAY;IAAA,IAAAwF,sBAAA;IACjB,IAAMC,EAAE,GAAG,CAAAD,sBAAA,GAAA7G,YAAY,CAACC,OAAO,CAAC,CAAC,CAAC,cAAA4G,sBAAA,eAAvBA,sBAAA,CAAyBE,oBAAoB,GAAGH,UAAU,GAAGD,eAAe;IACvF,OAAOG,EAAE,CAACE,KAAK,CAAC,IAAI,EAAE/B,SAAS,CAAC;EAClC,CAAC;AACH,CAAC,CAAE,CAAC,CAAC;AAEE,IAAMgC,sBAAsB,GAAGpC,QAAQ,CAAC,mBAAmB,EAAE,UAACa,EAAE,EAAEJ,OAAO,EAAEpB,KAAK;EAAA,OAAKG,aAAa,CAACrE,YAAY,CAACE,OAAO,CAAC,CAAC,CAAC,EAAEwF,EAAE,EAAEJ,OAAO,EAAEpB,KAAK,CAAC;AAAA,GAAE5C,UAAU,CAAC;;AAEnK;AACA;AACA;AACA,SAAS4F,oBAAoBA,CAAA,EAAG;EAC9B;EACA,IAAMC,SAAS,GAAG,SAAZA,SAASA,CAAaC,EAAE,EAAE;IAC9B,OAAOC,KAAK,CAACC,IAAI,CAACF,EAAE,CAAC5E,IAAI,CAAC,CAAC,CAAC,CAAC+E,MAAM,CAAC,UAAAC,EAAE;MAAA,OAAIA,EAAE,IAAI,IAAI;IAAA,EAAC;EACvD,CAAC;EACD,IAAMC,gBAAgB,GAAG;IACvBzG,cAAc,EAAEmG,SAAS,CAACnG,cAAc,CAAC;IACzCE,cAAc,EAAEiG,SAAS,CAACjG,cAAc,CAAC;IACzCC,gBAAgB,EAAEgG,SAAS,CAAChG,gBAAgB,CAAC;IAC7CC,WAAW,EAAE+F,SAAS,CAAC/F,WAAW,CAAC;IACnCC,WAAW,EAAE8F,SAAS,CAAC9F,WAAW,CAAC;IACnCC,UAAU,EAAE6F,SAAS,CAAC7F,UAAU;EAClC,CAAC;EAED9C,gDAAW,CAACC,wEAAiC,EAAEgJ,gBAAgB,CAAC;EAChE,CAACzG,cAAc,EAAEE,cAAc,EAAEC,gBAAgB,EAAEC,WAAW,EAAEC,WAAW,EAAEC,UAAU,CAAC,CAACuG,OAAO,CAAC,UAAAL,EAAE;IAAA,OAAIA,EAAE,CAACM,KAAK,CAAC,CAAC;EAAA,EAAC;AACpH;AAEAtJ,8CAAS,CAACC,mEAA4B,EAAEyI,oBAAoB,CAAC;;AAE7D;AACA;AACA;AACA;AACO,SAASe,oBAAoBA,CAAC5J,MAAM,EAAE;EAC3C,IAAI6J,KAAK,GAAGhK,yDAAU,CAACG,MAAM,EAAE,YAAY,CAAC;EAC5C,IAAI,CAAC6J,KAAK,EAAE;IACV9J,sDAAO,CAAC,sCAAsC,CAAC;EACjD;EACA8J,KAAK,GAAG3F,MAAM,CAAC4F,WAAW,CAAC,CAACD,KAAK,IAAI,EAAE,EAAEE,GAAG,CAAC,UAAAC,CAAC;IAAA,OAAI,CAACA,CAAC,CAACpI,OAAO,EAAEoI,CAAC,CAAC;EAAA,EAAC,CAAC;EAClE7G,wBAAwB,GAAG,CAAC,CAACtD,yDAAU,CAACG,MAAM,EAAE0B,0BAA0B,CAAC;EAE3EwC,MAAM,CAAC+F,OAAO,CAAClI,kBAAkB,CAAC,CAACyH,OAAO,CAAC,UAAAU,IAAA,EAAkB;IAAA,IAAAC,WAAA;IAAA,IAAAC,KAAA,GAAAC,gFAAA,CAAAH,IAAA;MAAhBzE,IAAI,GAAA2E,KAAA;MAAEE,IAAI,GAAAF,KAAA;IACrDzI,YAAY,CAAC2I,IAAI,CAACrI,IAAI,CAAC,CAACqI,IAAI,CAAChI,EAAE,CAAC,IAAA6H,WAAA,GAAGN,KAAK,CAACpE,IAAI,CAAC,cAAA0E,WAAA,cAAAA,WAAA,GAAIG,IAAI,CAACpI,OAAO;EAChE,CAAC,CAAC;EAEF,IAAI,CAACgB,UAAU,EAAE;IACf,IAAIvB,YAAY,CAACC,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE;MACnCsB,UAAU,GAAG,IAAI;MACjBI,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACC,kFAAsB,EAAEoC,SAAS,EAAEmE,gBAAgB,CAAC,CAAC;MAC/FlE,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACM,8EAAkB,EAAE+B,SAAS,EAAEoE,YAAY,CAAC,CAAC;MACvFnE,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACE,gFAAoB,EAAEmC,SAAS,EAAEqE,cAAc,CAAC,CAAC;IAC7F;IACA,IAAI/F,YAAY,CAACC,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE;MACnC0B,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACI,+EAAmB,EAAEiC,SAAS,EAAEsE,aAAa,CAAC,CAAC;IAC3F;IACA,IAAIhG,YAAY,CAACC,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE;MACnC0B,YAAY,CAACiH,IAAI,CACfvJ,kFAAuB,CAACS,kFAAsB,EAAE4B,SAAS,EAAEwE,QAAQ,CAAC,EACpE7G,kFAAuB,CAACG,gFAAoB,EAAEkC,SAAS,EAAEwE,QAAQ,CACnE,CAAC;IACH;IACA,IAAIlG,YAAY,CAACC,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE;MACnC0B,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACK,qFAAyB,EAAEgC,SAAS,EAAEuE,mBAAmB,CAAC,CAAC;IACvG;IACA,IAAIjG,YAAY,CAACE,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE;MACnCyB,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACQ,yFAA6B,EAAE6B,SAAS,EAAEuF,sBAAsB,CAAC,CAAC;IAC9G;IACAtF,YAAY,CAACiH,IAAI,CAACvJ,kFAAuB,CAACO,kFAAsB,EAAE8B,SAAS,EAAEyE,gBAAgB,CAAC,CAAC;EACjG;AACF;AAEO,SAAS0C,SAASA,CAAA,EAAG;EAC1B,OAAOlH,YAAY,CAACc,MAAM;IAAEd,YAAY,CAACmH,GAAG,CAAC,CAAC,CAAC,CAAC;EAAC;EACjDvH,UAAU,GAAG,KAAK;AACpB;AAEAlD,4DAAgB,CAAC,mBAAmB,EAAE,UAAAA,MAAM;EAAA,OAAI4J,oBAAoB,CAAC5J,MAAM,CAAC0K,iBAAiB,CAAC;AAAA,EAAC;AA3V/F9K,qEAAI,CAAC,iBAAiB,CAAC","sources":["webpack://prebid.js/./modules/gdprEnforcement.js"],"sourcesContent":["/**\n * This module gives publishers extra set of features to enforce individual purposes of TCF v2\n */\n\nimport {deepAccess, logError, logWarn} from '../src/utils.js';\nimport {config} from '../src/config.js';\nimport adapterManager, {gdprDataHandler} from '../src/adapterManager.js';\nimport * as events from '../src/events.js';\nimport CONSTANTS from '../src/constants.json';\nimport {GDPR_GVLIDS, VENDORLESS_GVLID, FIRST_PARTY_GVLID} from '../src/consentHandler.js';\nimport {\n  MODULE_TYPE_ANALYTICS,\n  MODULE_TYPE_BIDDER,\n  MODULE_TYPE_PREBID,\n  MODULE_TYPE_RTD,\n  MODULE_TYPE_UID\n} from '../src/activities/modules.js';\nimport {\n  ACTIVITY_PARAM_ANL_CONFIG,\n  ACTIVITY_PARAM_COMPONENT_NAME,\n  ACTIVITY_PARAM_COMPONENT_TYPE\n} from '../src/activities/params.js';\nimport {registerActivityControl} from '../src/activities/rules.js';\nimport {\n  ACTIVITY_ACCESS_DEVICE,\n  ACTIVITY_ENRICH_EIDS, ACTIVITY_ENRICH_UFPD,\n  ACTIVITY_FETCH_BIDS,\n  ACTIVITY_REPORT_ANALYTICS,\n  ACTIVITY_SYNC_USER, ACTIVITY_TRANSMIT_EIDS, ACTIVITY_TRANSMIT_PRECISE_GEO, ACTIVITY_TRANSMIT_UFPD\n} from '../src/activities/activities.js';\n\nexport const STRICT_STORAGE_ENFORCEMENT = 'strictStorageEnforcement';\n\nexport const ACTIVE_RULES = {\n  purpose: {},\n  feature: {}\n};\n\nconst CONSENT_PATHS = {\n  purpose: 'purpose.consents',\n  feature: 'specialFeatureOptins'\n};\n\nconst CONFIGURABLE_RULES = {\n  storage: {\n    type: 'purpose',\n    default: {\n      purpose: 'storage',\n      enforcePurpose: true,\n      enforceVendor: true,\n      vendorExceptions: []\n    },\n    id: 1,\n  },\n  basicAds: {\n    type: 'purpose',\n    id: 2,\n    default: {\n      purpose: 'basicAds',\n      enforcePurpose: true,\n      enforceVendor: true,\n      vendorExceptions: []\n    }\n  },\n  personalizedAds: {\n    type: 'purpose',\n    id: 4,\n  },\n  measurement: {\n    type: 'purpose',\n    id: 7,\n  },\n  transmitPreciseGeo: {\n    type: 'feature',\n    id: 1,\n  },\n};\n\nconst storageBlocked = new Set();\nconst biddersBlocked = new Set();\nconst analyticsBlocked = new Set();\nconst ufpdBlocked = new Set();\nconst eidsBlocked = new Set();\nconst geoBlocked = new Set();\n\nlet hooksAdded = false;\nlet strictStorageEnforcement = false;\n\nconst GVLID_LOOKUP_PRIORITY = [\n  MODULE_TYPE_BIDDER,\n  MODULE_TYPE_UID,\n  MODULE_TYPE_ANALYTICS,\n  MODULE_TYPE_RTD\n];\n\nconst RULE_NAME = 'TCF2';\nconst RULE_HANDLES = [];\n\n// in JS we do not have access to the GVL; assume that everyone declares legitimate interest for basic ads\nconst LI_PURPOSES = [2];\n\n/**\n * Retrieve a module's GVL ID.\n */\nexport function getGvlid(moduleType, moduleName, fallbackFn) {\n  if (moduleName) {\n    // Check user defined GVL Mapping in pbjs.setConfig()\n    const gvlMapping = config.getConfig('gvlMapping');\n\n    // Return GVL ID from user defined gvlMapping\n    if (gvlMapping && gvlMapping[moduleName]) {\n      return gvlMapping[moduleName];\n    } else if (moduleType === MODULE_TYPE_PREBID) {\n      return moduleName === 'cdep' ? FIRST_PARTY_GVLID : VENDORLESS_GVLID;\n    } else {\n      let {gvlid, modules} = GDPR_GVLIDS.get(moduleName);\n      if (gvlid == null && Object.keys(modules).length > 0) {\n        // this behavior is for backwards compatibility; if multiple modules with the same\n        // name declare different GVL IDs, pick the bidder's first, then userId, then analytics\n        for (const type of GVLID_LOOKUP_PRIORITY) {\n          if (modules.hasOwnProperty(type)) {\n            gvlid = modules[type];\n            if (type !== moduleType) {\n              logWarn(`Multiple GVL IDs found for module '${moduleName}'; using the ${type} module's ID (${gvlid}) instead of the ${moduleType}'s ID (${modules[moduleType]})`);\n            }\n            break;\n          }\n        }\n      }\n      if (gvlid == null && fallbackFn) {\n        gvlid = fallbackFn();\n      }\n      return gvlid || null;\n    }\n  }\n  return null;\n}\n\n/**\n * Retrieve GVL IDs that are dynamically set on analytics adapters.\n */\nexport function getGvlidFromAnalyticsAdapter(code, config) {\n  const adapter = adapterManager.getAnalyticsAdapter(code);\n  return ((gvlid) => {\n    if (typeof gvlid !== 'function') return gvlid;\n    try {\n      return gvlid.call(adapter.adapter, config);\n    } catch (e) {\n      logError(`Error invoking ${code} adapter.gvlid()`, e);\n    }\n  })(adapter?.adapter?.gvlid);\n}\n\nexport function shouldEnforce(consentData, purpose, name) {\n  if (consentData == null && gdprDataHandler.enabled) {\n    // there is no consent data, but the GDPR module has been installed and configured\n    // NOTE: this check is not foolproof, as when Prebid first loads, enforcement hooks have not been attached yet\n    // This piece of code would not run at all, and `gdprDataHandler.enabled` would be false, until the first\n    // `setConfig({consentManagement})`\n    logWarn(`Attempting operation that requires purpose ${purpose} consent while consent data is not available${name ? ` (module: ${name})` : ''}. Assuming no consent was given.`);\n    return true;\n  }\n  return consentData && consentData.gdprApplies;\n}\n\nfunction getConsent(consentData, type, id, gvlId) {\n  let purpose = !!deepAccess(consentData, `vendorData.${CONSENT_PATHS[type]}.${id}`);\n  let vendor = !!deepAccess(consentData, `vendorData.vendor.consents.${gvlId}`);\n\n  if (type === 'purpose' && LI_PURPOSES.includes(id)) {\n    purpose ||= !!deepAccess(consentData, `vendorData.purpose.legitimateInterests.${id}`);\n    vendor ||= !!deepAccess(consentData, `vendorData.vendor.legitimateInterests.${gvlId}`);\n  }\n  return {purpose, vendor};\n}\n\n/**\n * This function takes in a rule and consentData and validates against the consentData provided. Depending on what it returns,\n * the caller may decide to suppress a TCF-sensitive activity.\n * @param {Object} rule - enforcement rules set in config\n * @param {Object} consentData - gdpr consent data\n * @param {string=} currentModule - Bidder code of the current module\n * @param {number=} gvlId - GVL ID for the module\n * @returns {boolean}\n */\nexport function validateRules(rule, consentData, currentModule, gvlId) {\n  const ruleOptions = CONFIGURABLE_RULES[rule.purpose];\n\n  // return 'true' if vendor present in 'vendorExceptions'\n  if ((rule.vendorExceptions || []).includes(currentModule)) {\n    return true;\n  }\n  const vendorConsentRequred = rule.enforceVendor && !((gvlId === VENDORLESS_GVLID || (rule.softVendorExceptions || []).includes(currentModule)));\n  const {purpose, vendor} = getConsent(consentData, ruleOptions.type, ruleOptions.id, gvlId);\n\n  let validation = (!rule.enforcePurpose || purpose) && (!vendorConsentRequred || vendor);\n\n  if (gvlId === FIRST_PARTY_GVLID) {\n    validation = (!rule.enforcePurpose || !!deepAccess(consentData, `vendorData.publisher.consents.${ruleOptions.id}`));\n  }\n\n  return validation;\n}\n\nfunction gdprRule(purposeNo, checkConsent, blocked = null, gvlidFallback = () => null) {\n  return function (params) {\n    const consentData = gdprDataHandler.getConsentData();\n    const modName = params[ACTIVITY_PARAM_COMPONENT_NAME];\n\n    if (shouldEnforce(consentData, purposeNo, modName)) {\n      const gvlid = getGvlid(params[ACTIVITY_PARAM_COMPONENT_TYPE], modName, gvlidFallback(params));\n      let allow = !!checkConsent(consentData, modName, gvlid);\n      if (!allow) {\n        blocked && blocked.add(modName);\n        return {allow};\n      }\n    }\n  };\n}\n\nfunction singlePurposeGdprRule(purposeNo, blocked = null, gvlidFallback = () => null) {\n  return gdprRule(purposeNo, (cd, modName, gvlid) => !!validateRules(ACTIVE_RULES.purpose[purposeNo], cd, modName, gvlid), blocked, gvlidFallback);\n}\n\nfunction exceptPrebidModules(ruleFn) {\n  return function (params) {\n    if (params[ACTIVITY_PARAM_COMPONENT_TYPE] === MODULE_TYPE_PREBID) {\n      // TODO: this special case is for the PBS adapter (componentType is 'prebid')\n      // we should check for generic purpose 2 consent & vendor consent based on the PBS vendor's GVL ID;\n      // that is, however, a breaking change and skipped for now\n      return;\n    }\n    return ruleFn(params);\n  };\n}\n\nexport const accessDeviceRule = ((rule) => {\n  return function (params) {\n    // for vendorless (core) storage, do not enforce rules unless strictStorageEnforcement is set\n    if (params[ACTIVITY_PARAM_COMPONENT_TYPE] === MODULE_TYPE_PREBID && !strictStorageEnforcement) return;\n    return rule(params);\n  };\n})(singlePurposeGdprRule(1, storageBlocked));\n\nexport const syncUserRule = singlePurposeGdprRule(1, storageBlocked);\nexport const enrichEidsRule = singlePurposeGdprRule(1, storageBlocked);\nexport const fetchBidsRule = exceptPrebidModules(singlePurposeGdprRule(2, biddersBlocked));\nexport const reportAnalyticsRule = singlePurposeGdprRule(7, analyticsBlocked, (params) => getGvlidFromAnalyticsAdapter(params[ACTIVITY_PARAM_COMPONENT_NAME], params[ACTIVITY_PARAM_ANL_CONFIG]));\nexport const ufpdRule = singlePurposeGdprRule(4, ufpdBlocked);\n\nexport const transmitEidsRule = exceptPrebidModules((() => {\n  // Transmit EID special case:\n  // by default, legal basis or vendor exceptions for any purpose between 2 and 10\n  // (but disregarding enforcePurpose and enforceVendor config) is enough to allow EIDs through\n  function check2to10Consent(consentData, modName, gvlId) {\n    for (let pno = 2; pno <= 10; pno++) {\n      if (ACTIVE_RULES.purpose[pno]?.vendorExceptions?.includes(modName)) {\n        return true;\n      }\n      const {purpose, vendor} = getConsent(consentData, 'purpose', pno, gvlId);\n      if (purpose && (vendor || ACTIVE_RULES.purpose[pno]?.softVendorExceptions?.includes(modName))) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  const defaultBehavior = gdprRule('2-10', check2to10Consent, eidsBlocked);\n  const p4Behavior = singlePurposeGdprRule(4, eidsBlocked);\n  return function () {\n    const fn = ACTIVE_RULES.purpose[4]?.eidsRequireP4Consent ? p4Behavior : defaultBehavior;\n    return fn.apply(this, arguments);\n  };\n})());\n\nexport const transmitPreciseGeoRule = gdprRule('Special Feature 1', (cd, modName, gvlId) => validateRules(ACTIVE_RULES.feature[1], cd, modName, gvlId), geoBlocked);\n\n/**\n * Compiles the TCF2.0 enforcement results into an object, which is emitted as an event payload to \"tcf2Enforcement\" event.\n */\nfunction emitTCF2FinalResults() {\n  // remove null and duplicate values\n  const formatSet = function (st) {\n    return Array.from(st.keys()).filter(el => el != null);\n  };\n  const tcf2FinalResults = {\n    storageBlocked: formatSet(storageBlocked),\n    biddersBlocked: formatSet(biddersBlocked),\n    analyticsBlocked: formatSet(analyticsBlocked),\n    ufpdBlocked: formatSet(ufpdBlocked),\n    eidsBlocked: formatSet(eidsBlocked),\n    geoBlocked: formatSet(geoBlocked)\n  };\n\n  events.emit(CONSTANTS.EVENTS.TCF2_ENFORCEMENT, tcf2FinalResults);\n  [storageBlocked, biddersBlocked, analyticsBlocked, ufpdBlocked, eidsBlocked, geoBlocked].forEach(el => el.clear());\n}\n\nevents.on(CONSTANTS.EVENTS.AUCTION_END, emitTCF2FinalResults);\n\n/**\n * A configuration function that initializes some module variables, as well as adds hooks\n * @param {Object} config - GDPR enforcement config object\n */\nexport function setEnforcementConfig(config) {\n  let rules = deepAccess(config, 'gdpr.rules');\n  if (!rules) {\n    logWarn('TCF2: enforcing P1 and P2 by default');\n  }\n  rules = Object.fromEntries((rules || []).map(r => [r.purpose, r]));\n  strictStorageEnforcement = !!deepAccess(config, STRICT_STORAGE_ENFORCEMENT);\n\n  Object.entries(CONFIGURABLE_RULES).forEach(([name, opts]) => {\n    ACTIVE_RULES[opts.type][opts.id] = rules[name] ?? opts.default;\n  });\n\n  if (!hooksAdded) {\n    if (ACTIVE_RULES.purpose[1] != null) {\n      hooksAdded = true;\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_ACCESS_DEVICE, RULE_NAME, accessDeviceRule));\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_SYNC_USER, RULE_NAME, syncUserRule));\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_ENRICH_EIDS, RULE_NAME, enrichEidsRule));\n    }\n    if (ACTIVE_RULES.purpose[2] != null) {\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_FETCH_BIDS, RULE_NAME, fetchBidsRule));\n    }\n    if (ACTIVE_RULES.purpose[4] != null) {\n      RULE_HANDLES.push(\n        registerActivityControl(ACTIVITY_TRANSMIT_UFPD, RULE_NAME, ufpdRule),\n        registerActivityControl(ACTIVITY_ENRICH_UFPD, RULE_NAME, ufpdRule)\n      );\n    }\n    if (ACTIVE_RULES.purpose[7] != null) {\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_REPORT_ANALYTICS, RULE_NAME, reportAnalyticsRule));\n    }\n    if (ACTIVE_RULES.feature[1] != null) {\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_TRANSMIT_PRECISE_GEO, RULE_NAME, transmitPreciseGeoRule));\n    }\n    RULE_HANDLES.push(registerActivityControl(ACTIVITY_TRANSMIT_EIDS, RULE_NAME, transmitEidsRule));\n  }\n}\n\nexport function uninstall() {\n  while (RULE_HANDLES.length) RULE_HANDLES.pop()();\n  hooksAdded = false;\n}\n\nconfig.getConfig('consentManagement', config => setEnforcementConfig(config.consentManagement));\n"],"names":["registerModule","__r0","deepAccess","logError","logWarn","config","adapterManager","gdprDataHandler","events","CONSTANTS","GDPR_GVLIDS","VENDORLESS_GVLID","FIRST_PARTY_GVLID","MODULE_TYPE_ANALYTICS","MODULE_TYPE_BIDDER","MODULE_TYPE_PREBID","MODULE_TYPE_RTD","MODULE_TYPE_UID","ACTIVITY_PARAM_ANL_CONFIG","ACTIVITY_PARAM_COMPONENT_NAME","ACTIVITY_PARAM_COMPONENT_TYPE","registerActivityControl","ACTIVITY_ACCESS_DEVICE","ACTIVITY_ENRICH_EIDS","ACTIVITY_ENRICH_UFPD","ACTIVITY_FETCH_BIDS","ACTIVITY_REPORT_ANALYTICS","ACTIVITY_SYNC_USER","ACTIVITY_TRANSMIT_EIDS","ACTIVITY_TRANSMIT_PRECISE_GEO","ACTIVITY_TRANSMIT_UFPD","STRICT_STORAGE_ENFORCEMENT","ACTIVE_RULES","purpose","feature","CONSENT_PATHS","CONFIGURABLE_RULES","storage","type","default","enforcePurpose","enforceVendor","vendorExceptions","id","basicAds","personalizedAds","measurement","transmitPreciseGeo","storageBlocked","Set","biddersBlocked","analyticsBlocked","ufpdBlocked","eidsBlocked","geoBlocked","hooksAdded","strictStorageEnforcement","GVLID_LOOKUP_PRIORITY","RULE_NAME","RULE_HANDLES","LI_PURPOSES","getGvlid","moduleType","moduleName","fallbackFn","gvlMapping","getConfig","_GDPR_GVLIDS$get","get","gvlid","modules","Object","keys","length","_iterator","_createForOfIteratorHelper","_step","s","n","done","value","hasOwnProperty","concat","err","e","f","getGvlidFromAnalyticsAdapter","code","_adapter$adapter","adapter","getAnalyticsAdapter","call","shouldEnforce","consentData","name","enabled","gdprApplies","getConsent","gvlId","vendor","includes","validateRules","rule","currentModule","ruleOptions","vendorConsentRequred","softVendorExceptions","_getConsent","validation","gdprRule","purposeNo","checkConsent","blocked","arguments","undefined","gvlidFallback","params","getConsentData","modName","allow","add","singlePurposeGdprRule","cd","exceptPrebidModules","ruleFn","accessDeviceRule","syncUserRule","enrichEidsRule","fetchBidsRule","reportAnalyticsRule","ufpdRule","transmitEidsRule","check2to10Consent","pno","_ACTIVE_RULES$purpose","_ACTIVE_RULES$purpose2","_ACTIVE_RULES$purpose3","_ACTIVE_RULES$purpose4","_getConsent2","defaultBehavior","p4Behavior","_ACTIVE_RULES$purpose5","fn","eidsRequireP4Consent","apply","transmitPreciseGeoRule","emitTCF2FinalResults","formatSet","st","Array","from","filter","el","tcf2FinalResults","emit","EVENTS","TCF2_ENFORCEMENT","forEach","clear","on","AUCTION_END","setEnforcementConfig","rules","fromEntries","map","r","entries","_ref","_rules$name","_ref2","_slicedToArray","opts","push","uninstall","pop","consentManagement"],"sourceRoot":""}